<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Status Validator</title>

    <script src="./hls.js"></script>

    <!-- Dark theme + layout -->
    <style>
      :root {
        color-scheme: dark;
      }

      html,
      body {
        height: 100%;
        margin: 0;
        background: #0b0f14;
        color: #e6edf3;
        font-family: system-ui, -apple-system, "Segoe UI", Roboto,
          "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif;
      }

      /* App layout: header + player */
      .app {
        height: 100%;
        display: flex;
        flex-direction: column;
      }

      .toolbar {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 0;
        margin: 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        background: #0e141b;
      }

      .label {
        font-size: 14px;
        opacity: 0.9;
        white-space: nowrap;
      }

      select {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;

        background: #111a24;
        color: #e6edf3;
        border: 1px solid rgba(255, 255, 255, 0.14);
        border-radius: 0;
        padding: 12px 36px 12px 12px;
        font-size: 14px;
        outline: none;
        cursor: pointer;
        width: 100%;
        box-sizing: border-box;
      }

      select:focus {
        border-color: rgba(255, 255, 255, 0.28);
        box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.08);
      }

      /* simple dropdown arrow */
      .select-wrap {
        position: relative;
        display: block;
        align-items: stretch;
        width: 100%;
      }
      .select-wrap::after {
        content: "▾";
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        pointer-events: none;
        opacity: 0.8;
      }

      .player {
        flex: 1;
        min-height: 0; /* important for flex children */
        display: flex;
      }

      video {
        width: 100%;
        height: 100%;
        background: #000;
      }
    </style>
  </head>

  <!-- bodyは空（タグを含めない） -->
  <body>
    <script src="./crypto-js.min.js" crossorigin="anonymous"></script>
    <script>
      class CodeMod {
        decode(input) {
          let out = "";
          for (let i = 0; i < input.length; i++) {
            const c = input.charCodeAt(i);

            if (c === 126) {
              out += String.fromCharCode(10); // LF
            } else if (c === 32) {
              out += String.fromCharCode(125);
            } else if (c >= 33 && c <= 126) {
              out += String.fromCharCode(c - 1);
            } else {
              out += input.charAt(i);
            }
          }
          return out;
        }
      }
      const codeMod = new CodeMod();

      class CLoader extends Hls.DefaultConfig.loader {
        constructor(config) {
          super(config);
        }
        transformData(data) {
          // xor 170 all bytes
          for (let i = 0; i < data.length; i++) {
            data[i] = data[i] ^ 170;
          }
          return data;
        }

        load(context, config, callbacks) {
          context.url = context.url
            .replace(/.+E/, "https://cdn.jsdelivr.net/gh/kaeru-shigure/k7/E")
            .replace(/\.m3u8$/, ".dat")
            .replace(/\.ts$/, ".bin");
          callbacks = { ...callbacks };
          const onSuccess = callbacks.onSuccess;
          if (onSuccess) {
            callbacks.onSuccess = (response, stats, context) => {
              if (typeof response.data === "string") {
                response.data = codeMod.decode(response.data);
              }
              if (response.data instanceof ArrayBuffer) {
                response.data = this.transformData(
                  new Uint8Array(response.data)
                ).buffer;
              }
              onSuccess(response, stats, context);
            };
          }
          const onProgress = callbacks.onProgress;
          if (onProgress) {
            callbacks.onProgress = (stats, context, data) => {
              if (typeof data === "string") {
                data = codeMod.decode(data);
              }
              if (data instanceof ArrayBuffer) {
                data = this.transformData(new Uint8Array(data)).buffer;
              }
              onProgress(stats, context, data);
            };
          }
          return super.load(context, config, callbacks);
        }
      }

      if (!localStorage.hls_k7_pw) {
        throw new Error("Invalid request: should set localStorage.hls_k7_pw");
      }
      // fetch encrypted.bin and decrypt and load as script
      fetch("./encrypted.bin")
        .then((res) => res.arrayBuffer())
        .then((encBuf) => {
          const pw = localStorage.hls_k7_pw;
          // encrypt by pw using AES
          const key = CryptoJS.SHA256(pw);
          const iv = CryptoJS.MD5(pw).words;
          const encWordArray = CryptoJS.lib.WordArray.create(
            new Uint8Array(encBuf)
          );
          const decrypted = CryptoJS.AES.decrypt(
            { ciphertext: encWordArray },
            key,
            {
              iv: CryptoJS.lib.WordArray.create(iv),
              mode: CryptoJS.mode.CBC,
              padding: CryptoJS.pad.Pkcs7,
            }
          );
          const decryptedText = decrypted.toString(CryptoJS.enc.Utf8);
          // create blob url and load
          const blob = new Blob([decryptedText], {
            type: "application/javascript",
          });
          const blobUrl = URL.createObjectURL(blob);
          const script = document.createElement("script");
          script.src = blobUrl;
          document.body.appendChild(script);
        });
    </script>
  </body>
</html>
